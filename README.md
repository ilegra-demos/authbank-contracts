<div align="center">

# BBRLPlus (Brazilian Bank Real Plus Token)

**Token ERC20 avan√ßado com seguran√ßa, governan√ßa granular e rastreabilidade de opera√ß√µes para representar BRL tokenizado.**

</div>

> Documenta√ß√£o unificada: todo o conte√∫do de testes, scripts e opera√ß√µes est√° concentrado neste arquivo (`README.md`). READMEs secund√°rios foram removidos para evitar duplica√ß√£o.

## üß≠ √çndice

1. [Vis√£o Geral](#-vis√£o-geral)
2. [Arquitetura & Stack](#-arquitetura--stack)
3. [Estrutura do Projeto](#-estrutura-do-projeto)
4. [Configura√ß√£o & Ambiente](#-configura√ß√£o--ambiente)
5. [Build & Desenvolvimento](#-build--desenvolvimento)
6. [Contrato Principal](#-contrato-principal-bbrlplussol)
7. [Novos Contratos (PaymentGroup e PaymentGroupFactory)](#-novos-contratos-paymentgroup-e-paymentgroupfactory)
8. [Scripts (Deploy / Opera√ß√µes / Query / Exemplos)](#-scripts)
9. [Testes (Unit / Integra√ß√£o / Performance)](#-testes)
10. [Relat√≥rios: Gas, Cobertura, Snapshots](#-relat√≥rios-gas-cobertura-snapshots)
11. [Debug & Ferramentas (Forge, Cast, Chisel)](#-debug--ferramentas)
12. [M√©tricas & Benchmarks](#-m√©tricas--benchmarks)
13. [Checklists (Dev / CI / Deploy)](#-checklists)
14. [Seguran√ßa & Boas Pr√°ticas](#-seguran√ßa--boas-pr√°ticas)
15. [Ambiente & Vari√°veis (.env)](#-ambiente--vari√°veis-env)
16. [Contribui√ß√£o](#-contribui√ß√£o)
17. [Licen√ßa](#-licen√ßa)

---

## üìã Vis√£o Geral

Caracter√≠sticas chave:

- üîê **Controle de Acesso Granular** (roles: Admin, Minter, Burner, Pauser, Recovery)
- üö´ **DenyList por Modelo Negativo** (somente endere√ßos bloqueados s√£o restringidos)
- üõë **Paus√°vel** (resposta a incidentes / emerg√™ncia)
- ü™ô **Mint & Burn Controlados** (auditoria via refer√™ncia)
- ‚ôªÔ∏è **Recupera√ß√£o de Tokens** (endere√ßos bloqueados / incidentes)
- ‚úçÔ∏è **ERC20Permit (EIP‚Äë2612)** para aprova√ß√µes gasless
- üßæ **Refer√™ncias em Opera√ß√µes** (mint / burn / transfer com metadata curta)

## üß± Arquitetura & Stack

| Componente | Uso |
|------------|-----|
| Solidity ^0.8.27 | Linguagem de contrato |
| Foundry (Forge, Cast, Anvil, Chisel) | Build, teste, intera√ß√£o |
| OpenZeppelin 5.4.0 | Primitivas seguras |
| forge-std 1.10.0 | Utilidades de teste |
| Soldeer | Gest√£o de depend√™ncias |

Rede suportada via `foundry.toml` (exemplo custom: `[bnbtestnet]`).

## üìÅ Estrutura do Projeto

```
src/                  # Contratos
script/               # Scripts operacionais (deploy, admin, intera√ß√£o, query, exemplos)
test/                 # Testes unit√°rios, integra√ß√£o, performance, helpers
lib/                  # Depend√™ncias (forge-std, openzeppelin)
broadcast/            # Sa√≠das de execu√ß√£o forge script
cache/ & out/         # Artefatos de compila√ß√£o
foundry.toml          # Configura√ß√£o Foundry
.env(.example)        # Vari√°veis de ambiente
```

## ‚öôÔ∏è Configura√ß√£o & Ambiente

Instalar Foundry:
```bash
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

Clonar & instalar depend√™ncias:
```bash
git clone <repository-url>
cd authbank-project
forge install
cp .env.example .env
```

Editar `.env` (exemplo m√≠nimo):
```bash
BNBTESTNET_RPC_URL="https://..."  # ou TESTNET / MAINNET
LOCAL_RPC_URL="http://127.0.0.1:8545"

PRIVATE_KEY="0x..."          # nunca commitar
ADMIN_ADDRESS="0x..."
MINTER_ADDRESS="0x..."
```

## üõ† Build & Desenvolvimento

```bash
forge build            # Compila
forge build --sizes    # Tamanhos
forge fmt              # Formata
forge clean && forge build # Limpa e recompila
```

### Qualidade
```bash
forge test --summary
forge coverage --report lcov
forge snapshot
```

## üßæ Contrato Principal: `BBRLPlus.sol`

Heran√ßa: `ERC20`, `ERC20Burnable`, `ERC20Pausable`, `AccessControl`, `ERC20Permit`.

Roles:
- `DEFAULT_ADMIN_ROLE`
- `PAUSER_ROLE`
- `MINTER_ROLE`
- `BURNER_ROLE`
- `RECOVERY_ROLE`

Principais fun√ß√µes estendidas:
- `mintRef(address to,uint256 amount,string ref)`
- `burnFromRef(address from,uint256 amount,string ref)`
- `transferWithRef(address to,uint256 amount,string ref)`
- `recoverTokens(address from,string ref,uint256 amount)`
- `addToDenylist(address)` / `removeFromDenylist(address)`

Invariantes (testadas):
1. Total supply = soma dos balances
2. Endere√ßo na denylist n√£o pode ser origem ou destino
3. Opera√ß√µes pausadas bloqueiam muta√ß√µes

## üÜï Novos Contratos (PaymentGroup e PaymentGroupFactory)

### PaymentGroupFactory (`NewGroup.sol`)
Factory contract para criar e gerenciar inst√¢ncias de `PaymentGroup`. Fornece controle de acesso para cria√ß√£o de contratos e mant√©m um registro de todos os contratos criados com seus par√¢metros.

**Principais Fun√ß√µes:**
- `createPaymentGroup(address _originToken, address _paymentToken, address _admin, uint256 _rewardPercentBps)`: Cria um novo PaymentGroup (apenas CREATOR_ROLE).
- `getCreatedGroupsCount()`: Retorna o n√∫mero total de grupos criados.
- `getGroupInfo(address contractAddress)`: Retorna informa√ß√µes sobre um grupo espec√≠fico.
- `getCreatedGroups(uint256 offset, uint256 limit)`: Lista paginada de grupos criados.
- `grantCreatorRole(address account)` / `revokeCreatorRole(address account)`: Gerenciamento de roles (apenas admin).

**Roles:**
- `DEFAULT_ADMIN_ROLE`: Controle administrativo.
- `CREATOR_ROLE`: Permiss√£o para criar novos grupos.

### PaymentGroup (`PaymentGroup.sol`)
Contrato que gerencia um grupo de participantes e distribui recompensas em um token de pagamento baseado em uma porcentagem do saldo do token de origem. As recompensas s√£o acionadas manualmente por operadores autorizados.

**Principais Fun√ß√µes:**
- `setTokens(address _tokenA, address _tokenB)`: Configura os tokens de origem e pagamento (apenas admin).
- `setRewardPercentBps(uint256 newPercent)`: Atualiza a porcentagem de recompensa (apenas admin).
- `addParticipant(address account)` / `removeParticipant(address account)`: Gerenciamento de participantes (apenas operator).
- `triggerPayment()`: Aciona distribui√ß√£o de recompensas para todos os participantes (apenas operator).
- `previewUserReward(address user)`: Pr√©via da recompensa para um usu√°rio espec√≠fico.
- `previewAllRewards()`: Pr√©via das recompensas para todos os participantes.
- `pause()` / `unpause()`: Controle de pausa (apenas admin).

**Roles:**
- `DEFAULT_ADMIN_ROLE`: Controle administrativo (configura√ß√£o, pausa).
- `OPERATOR_ROLE`: Opera√ß√µes di√°rias (adicionar participantes, acionar pagamentos).

### Explica√ß√£o Simplificada: C√°lculo do `rewardPercentBps`
O `rewardPercentBps` representa a porcentagem de recompensa em **basis points** (bps), onde:
- 1% = 10,000 bps
- 100% = 1,000,000 bps (m√°ximo permitido)

**F√≥rmula para calcular:**
```
rewardPercentBps = (porcentagem desejada em %) * 10,000
```

**Exemplos:**
- Para 5%: `5 * 10,000 = 50,000`
- Para 0.5%: `0.5 * 10,000 = 5,000`
- Para 10%: `10 * 10,000 = 100,000`

No contrato, a recompensa √© calculada como: `rewardAmount = (balanceA * rewardPercentBps) / 1,000,000`

### Exemplos de Invoca√ß√£o

#### Criar um novo PaymentGroup via Factory
```bash
# Usando cast para chamar a fun√ß√£o createPaymentGroup
cast send $FACTORY_ADDRESS "createPaymentGroup(address,address,address,uint256)" \
    $ORIGIN_TOKEN $PAYMENT_TOKEN $ADMIN 50000 \
    --private-key $PRIVATE_KEY --rpc-url $RPC_URL
```

#### Adicionar Participante a um PaymentGroup
```bash
cast send $PAYMENT_GROUP_ADDRESS "addParticipant(address)" $PARTICIPANT_ADDRESS \
    --private-key $PRIVATE_KEY --rpc-url $RPC_URL
```

#### Acionar Distribui√ß√£o de Recompensas
```bash
cast send $PAYMENT_GROUP_ADDRESS "triggerPayment()" \
    --private-key $PRIVATE_KEY --rpc-url $RPC_URL
```

#### Pr√©via de Recompensa para um Usu√°rio
```bash
cast call $PAYMENT_GROUP_ADDRESS "previewUserReward(address)" $USER_ADDRESS \
    --rpc-url $RPC_URL
```

#### Listar Grupos Criados pela Factory
```bash
cast call $FACTORY_ADDRESS "getCreatedGroups(uint256,uint256)" 0 10 \
    --rpc-url $RPC_URL
```

## üìú Scripts

Todos escritos em Solidity Script (`forge script`). Ap√≥s deploy atualize a `CONTRACT_ADDRESS` nos scripts que interagem.

| Script | Prop√≥sito | Principais A√ß√µes |
|--------|-----------|------------------|
| `DeployBBRLPlus.s.sol` | Deploy inicial | Define roles, valida setup |
| `AdminBBRLPlus.s.sol` | Governan√ßa/roles/denylist | Grant/Revoke/Pause/Recovery |
| `InteractBBRLPlus.s.sol` | Opera√ß√µes b√°sicas | Mint / Transfer / Burn |
| `QueryBBRLPlus.s.sol` | Relat√≥rios e leitura | Overview / Stats / Permissions |
| `ExampleUsageBBRLPlus.s.sol` | Workflows completos | Onboarding / Recovery / Demo |

### Exemplos
```bash
# Deploy (testnet)
forge script script/DeployBBRLPlus.s.sol:DeployBBRLPlus \
    --rpc-url $BNBTESTNET_RPC_URL \
    --private-key $PRIVATE_KEY \
    --broadcast --verify

# Opera√ß√µes administrativas
forge script script/AdminBBRLPlus.s.sol:AdminBBRLPlus \
    --rpc-url $RPC_URL --private-key $PRIVATE_KEY --broadcast

# Consulta (dry run)
forge script script/QueryBBRLPlus.s.sol:QueryBBRLPlus --rpc-url $RPC_URL
```

Uso com assinatura espec√≠fica (`--sig`):
```bash
forge script script/ExampleUsageBBRLPlus.s.sol:ExampleUsageBBRLPlus \
    --sig "onboardingExample(address)" 0x1234... --rpc-url $RPC_URL --private-key $PRIVATE_KEY --broadcast
```

## üß™ Testes

Total atual: **‚âà60 testes** (unit + integra√ß√£o + performance) cobrindo 100% das funcionalidades cr√≠ticas.

| Categoria | Arquivo | Escopo | Qtd aprox |
|-----------|---------|--------|-----------|
| Unit | `BBRLPlus.t.sol` | Fun√ß√µes isoladas & invariantes | 36 |
| Integra√ß√£o | `BBRLPlusIntegration.t.sol` | Workflows / cen√°rios compostos | 13 |
| Performance | `BBRLPlusPerformance.t.sol` | Benchmarks gas & stress | 11 |

Execu√ß√£o b√°sica:
```bash
forge test                      # todos
forge test -vvvv                # m√°ximo debug
forge test --match-contract BBRLPlusIntegrationTest
forge test --match-test test_MintRef
```

Fuzz / invariantes / seeds:
```bash
forge test --fuzz-runs 1000 --match-test testFuzz
forge test --fuzz-seed 42
forge test --match-test test_Invariant_TotalSupply
```

Isolamento & debug:
```bash
forge test --match-test test_RevertWhen_Transfer_UnauthorizedReceiver --isolate -vvvv --debug
```

## üìä Relat√≥rios (Gas, Cobertura, Snapshot)

```bash
forge test --gas-report
forge coverage --report lcov
forge snapshot                # cria/atualiza .gas-snapshot
forge snapshot --diff .gas-snapshot
```

Filtrar:
```bash
forge test --match-contract BBRLPlusPerformanceTest --gas-report
forge coverage --match-path src/BBRLPlus.sol
```

## üß™‚û°Ô∏èüîç Fluxo Recomendado de Teste
1. `forge test --summary`
2. `forge test --gas-report`
3. `forge coverage`
4. `forge snapshot --diff .gas-snapshot`
5. Executar performance apenas antes de PR final: `forge test --match-contract BBRLPlusPerformanceTest`

## üêû Debug & Ferramentas

Cast:
```bash
cast balance $ADDRESS --rpc-url $RPC_URL
cast call $CONTRACT "balanceOf(address)" $USER --rpc-url $RPC_URL
cast send $CONTRACT "transfer(address,uint256)" $TO 1000 \
    --private-key $PRIVATE_KEY --rpc-url $RPC_URL
```

Chisel REPL:
```bash
chisel
!load src/BBRLPlus.sol
```

Snapshots / repetibilidade:
```bash
forge test --fail-fast
forge test --fuzz-seed 123
```

## üìà M√©tricas & Benchmarks

Gas m√©dio aproximado:
```
Mint                ~67k
Transfer            ~96k
TransferWithRef     ~101k
AddToDenylist       ~63k
Burn                ~77k
Recovery            ~121k
Role Check          ~3k
```

Escalabilidade:
```
Denylist lookup:   O(1) (EnumerableSet)
Batch transfers:   Escala linear at√© 200+ opera√ß√µes
Invariantes:       Est√°veis sob muta√ß√µes simult√¢neas
```

## ‚úÖ Checklists

### Desenvolvimento Di√°rio
```bash
forge test --no-match-contract BBRLPlusPerformanceTest --summary
forge fmt --check
```

### Pr√©-PR
```bash
forge test
forge coverage
forge test --gas-report
forge snapshot --diff .gas-snapshot
```

### Pr√©-Deploy
```bash
forge build --sizes
forge test --match-contract BBRLPlusPerformanceTest
forge coverage --report lcov
forge snapshot
```

## üîê Seguran√ßa & Boas Pr√°ticas

1. Nunca commitar chaves privadas (usar `.env` + hardware wallet em produ√ß√£o)
2. Revisar roles definidas no script de deploy antes de broadcast
3. Testar em testnet ‚Üí validar ‚Üí s√≥ ent√£o mainnet
4. Verificar contrato (explorer) e reter endere√ßo em vari√°vel imut√°vel de monitoramento
5. Limitar frequ√™ncia de opera√ß√µes de recovery e registrar refer√™ncia (`ref`)

### Considera√ß√µes de Modelo de Amea√ßa
- Denylist atua como mecanismo reativo (n√£o preventivo KYC completo)
- Pausa √© controle de mitiga√ß√£o de incidente, n√£o substitui auditoria
- Refer√™ncias servem para auditoria off-chain (logs indexados)

## üå± Ambiente & Vari√°veis (.env)
Chaves comuns:
```bash
BNBTESTNET_RPC_URL=
LOCAL_RPC_URL=
PRIVATE_KEY=
ADMIN_ADDRESS=
MINTER_ADDRESS=
```

Use perfis adicionais em `foundry.toml` para redes extras.

## ü§ù Contribui√ß√£o
1. Fork
2. Branch feature: `git checkout -b feature/minha-feature`
3. Commits descritivos
4. Executar checklists (test/gas/coverage)
5. Abrir PR com descri√ß√£o clara

## üìÑ Licen√ßa
MIT License. Consulte `LICENSE`.

---

> D√∫vidas ou melhorias? Abra uma issue ou PR. Documenta√ß√£o ser√° expandida conforme novas capacidades forem adicionadas (ex: bridging, compliance hooks, batch operations).
